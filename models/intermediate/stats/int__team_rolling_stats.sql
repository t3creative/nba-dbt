{{ config(
    materialized='incremental',
    unique_key='team_game_key',
    incremental_strategy='delete+insert',
    tags=['intermediate', 'stats'],
    indexes=[
        {'columns': ['team_game_key'], 'unique': True},
        {'columns': ['game_id']},
        {'columns': ['team_id']},
        {'columns': ['opponent_id']},
        {'columns': ['game_date']},
        {'columns': ['season_year']}
    ]
)
}}

{% set rolling_window_games = var('rolling_window_games', 10) %}

with boxscores as (
    select
        -- Identifiers
        team_game_key,
        game_id,
        team_id,
        game_date,
        season_year,
        opponent_id,

        -- Select ALL numeric stats from int__team_boxscores
        -- Traditional
        min,
        fgm,
        fga,
        fg_pct,
        fg3m,
        fg3a,
        fg3_pct,
        ftm,
        fta,
        ft_pct,
        off_reb,
        def_reb,
        reb,
        ast,
        stl,
        blk,
        tov,
        pf,
        pts,
        plus_minus,

        -- Advanced
        est_off_rating,
        off_rating,
        est_def_rating,
        def_rating,
        est_net_rating,
        net_rating,
        ast_pct,
        ast_to_tov_ratio,
        ast_ratio,
        off_reb_pct,
        def_reb_pct,
        reb_pct,
        est_team_tov_pct,
        tov_ratio,
        eff_fg_pct,
        ts_pct,
        usage_pct,
        est_usage_pct,
        est_pace,
        pace,
        pace_per_40,
        possessions,
        pie,

        -- Hustle
        cont_shots,
        cont_2pt,
        cont_3pt,
        deflections,
        charges_drawn,
        screen_ast,
        screen_ast_pts,
        off_loose_balls_rec,
        def_loose_balls_rec,
        tot_loose_balls_rec,
        off_box_outs,
        def_box_outs,
        box_out_team_reb,
        box_out_player_reb,
        tot_box_outs,

        -- Misc
        pts_off_tov,
        second_chance_pts,
        fastbreak_pts,
        pts_in_paint,
        opp_pts_off_tov,
        opp_second_chance_pts,
        opp_fastbreak_pts,
        opp_pts_in_paint,

        -- Scoring
        pct_fga_2pt,
        pct_fga_3pt,
        pct_pts_2pt,
        pct_pts_midrange_2pt,
        pct_pts_3pt,
        pct_pts_fastbreak,
        pct_pts_ft,
        pct_pts_off_tov,
        pct_pts_in_paint,
        pct_assisted_2pt,
        pct_unassisted_2pt,
        pct_assisted_3pt,
        pct_unassisted_3pt,
        pct_assisted_fgm,
        pct_unassisted_fgm,

        -- Timestamps for Incremental
        updated_at

    from {{ ref('int__team_boxscores') }}
    {% if is_incremental() %}
    -- Look back N+1 days to ensure rolling calculations are correct near the incremental boundary
    where game_date >= (
        select max(game_date) - interval '{{ rolling_window_games + 1 }} days'
        from {{ this }}
    )
    {% endif %}
),

final as (
    select
        -- Identifiers
        team_game_key,
        game_id,
        team_id,
        game_date,
        season_year,
        opponent_id,

        -- Calculate rolling average, stddev, and lag for each specified stat

        -- Traditional
        {{ calculate_rolling_avg('min', 'team_id', 'game_date') }} as min_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('min', 'team_id', 'game_date') }} as min_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('min', 'team_id', 'game_date', 1) }} as min_lag_1g,
        {{ calculate_rolling_avg('fgm', 'team_id', 'game_date') }} as fgm_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('fgm', 'team_id', 'game_date') }} as fgm_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('fgm', 'team_id', 'game_date', 1) }} as fgm_lag_1g,
        {{ calculate_rolling_avg('fga', 'team_id', 'game_date') }} as fga_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('fga', 'team_id', 'game_date') }} as fga_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('fga', 'team_id', 'game_date', 1) }} as fga_lag_1g,
        {{ calculate_rolling_avg('fg_pct', 'team_id', 'game_date') }} as fg_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('fg_pct', 'team_id', 'game_date') }} as fg_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('fg_pct', 'team_id', 'game_date', 1) }} as fg_pct_lag_1g,
        {{ calculate_rolling_avg('fg3m', 'team_id', 'game_date') }} as fg3m_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('fg3m', 'team_id', 'game_date') }} as fg3m_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('fg3m', 'team_id', 'game_date', 1) }} as fg3m_lag_1g,
        {{ calculate_rolling_avg('fg3a', 'team_id', 'game_date') }} as fg3a_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('fg3a', 'team_id', 'game_date') }} as fg3a_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('fg3a', 'team_id', 'game_date', 1) }} as fg3a_lag_1g,
        {{ calculate_rolling_avg('fg3_pct', 'team_id', 'game_date') }} as fg3_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('fg3_pct', 'team_id', 'game_date') }} as fg3_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('fg3_pct', 'team_id', 'game_date', 1) }} as fg3_pct_lag_1g,
        {{ calculate_rolling_avg('ftm', 'team_id', 'game_date') }} as ftm_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('ftm', 'team_id', 'game_date') }} as ftm_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('ftm', 'team_id', 'game_date', 1) }} as ftm_lag_1g,
        {{ calculate_rolling_avg('fta', 'team_id', 'game_date') }} as fta_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('fta', 'team_id', 'game_date') }} as fta_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('fta', 'team_id', 'game_date', 1) }} as fta_lag_1g,
        {{ calculate_rolling_avg('ft_pct', 'team_id', 'game_date') }} as ft_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('ft_pct', 'team_id', 'game_date') }} as ft_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('ft_pct', 'team_id', 'game_date', 1) }} as ft_pct_lag_1g,
        {{ calculate_rolling_avg('off_reb', 'team_id', 'game_date') }} as off_reb_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('off_reb', 'team_id', 'game_date') }} as off_reb_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('off_reb', 'team_id', 'game_date', 1) }} as off_reb_lag_1g,
        {{ calculate_rolling_avg('def_reb', 'team_id', 'game_date') }} as def_reb_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('def_reb', 'team_id', 'game_date') }} as def_reb_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('def_reb', 'team_id', 'game_date', 1) }} as def_reb_lag_1g,
        {{ calculate_rolling_avg('reb', 'team_id', 'game_date') }} as reb_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('reb', 'team_id', 'game_date') }} as reb_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('reb', 'team_id', 'game_date', 1) }} as reb_lag_1g,
        {{ calculate_rolling_avg('ast', 'team_id', 'game_date') }} as ast_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('ast', 'team_id', 'game_date') }} as ast_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('ast', 'team_id', 'game_date', 1) }} as ast_lag_1g,
        {{ calculate_rolling_avg('stl', 'team_id', 'game_date') }} as stl_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('stl', 'team_id', 'game_date') }} as stl_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('stl', 'team_id', 'game_date', 1) }} as stl_lag_1g,
        {{ calculate_rolling_avg('blk', 'team_id', 'game_date') }} as blk_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('blk', 'team_id', 'game_date') }} as blk_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('blk', 'team_id', 'game_date', 1) }} as blk_lag_1g,
        {{ calculate_rolling_avg('tov', 'team_id', 'game_date') }} as tov_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('tov', 'team_id', 'game_date') }} as tov_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('tov', 'team_id', 'game_date', 1) }} as tov_lag_1g,
        {{ calculate_rolling_avg('pf', 'team_id', 'game_date') }} as pf_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pf', 'team_id', 'game_date') }} as pf_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pf', 'team_id', 'game_date', 1) }} as pf_lag_1g,
        {{ calculate_rolling_avg('pts', 'team_id', 'game_date') }} as pts_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pts', 'team_id', 'game_date') }} as pts_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pts', 'team_id', 'game_date', 1) }} as pts_lag_1g,
        {{ calculate_rolling_avg('plus_minus', 'team_id', 'game_date') }} as plus_minus_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('plus_minus', 'team_id', 'game_date') }} as plus_minus_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('plus_minus', 'team_id', 'game_date', 1) }} as plus_minus_lag_1g,

        -- Advanced
        {{ calculate_rolling_avg('est_off_rating', 'team_id', 'game_date') }} as est_off_rating_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('est_off_rating', 'team_id', 'game_date') }} as est_off_rating_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('est_off_rating', 'team_id', 'game_date', 1) }} as est_off_rating_lag_1g,
        {{ calculate_rolling_avg('off_rating', 'team_id', 'game_date') }} as off_rating_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('off_rating', 'team_id', 'game_date') }} as off_rating_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('off_rating', 'team_id', 'game_date', 1) }} as off_rating_lag_1g,
        {{ calculate_rolling_avg('est_def_rating', 'team_id', 'game_date') }} as est_def_rating_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('est_def_rating', 'team_id', 'game_date') }} as est_def_rating_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('est_def_rating', 'team_id', 'game_date', 1) }} as est_def_rating_lag_1g,
        {{ calculate_rolling_avg('def_rating', 'team_id', 'game_date') }} as def_rating_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('def_rating', 'team_id', 'game_date') }} as def_rating_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('def_rating', 'team_id', 'game_date', 1) }} as def_rating_lag_1g,
        {{ calculate_rolling_avg('est_net_rating', 'team_id', 'game_date') }} as est_net_rating_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('est_net_rating', 'team_id', 'game_date') }} as est_net_rating_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('est_net_rating', 'team_id', 'game_date', 1) }} as est_net_rating_lag_1g,
        {{ calculate_rolling_avg('net_rating', 'team_id', 'game_date') }} as net_rating_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('net_rating', 'team_id', 'game_date') }} as net_rating_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('net_rating', 'team_id', 'game_date', 1) }} as net_rating_lag_1g,
        {{ calculate_rolling_avg('ast_pct', 'team_id', 'game_date') }} as ast_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('ast_pct', 'team_id', 'game_date') }} as ast_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('ast_pct', 'team_id', 'game_date', 1) }} as ast_pct_lag_1g,
        {{ calculate_rolling_avg('ast_to_tov_ratio', 'team_id', 'game_date') }} as ast_to_tov_ratio_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('ast_to_tov_ratio', 'team_id', 'game_date') }} as ast_to_tov_ratio_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('ast_to_tov_ratio', 'team_id', 'game_date', 1) }} as ast_to_tov_ratio_lag_1g,
        {{ calculate_rolling_avg('ast_ratio', 'team_id', 'game_date') }} as ast_ratio_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('ast_ratio', 'team_id', 'game_date') }} as ast_ratio_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('ast_ratio', 'team_id', 'game_date', 1) }} as ast_ratio_lag_1g,
        {{ calculate_rolling_avg('off_reb_pct', 'team_id', 'game_date') }} as off_reb_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('off_reb_pct', 'team_id', 'game_date') }} as off_reb_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('off_reb_pct', 'team_id', 'game_date', 1) }} as off_reb_pct_lag_1g,
        {{ calculate_rolling_avg('def_reb_pct', 'team_id', 'game_date') }} as def_reb_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('def_reb_pct', 'team_id', 'game_date') }} as def_reb_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('def_reb_pct', 'team_id', 'game_date', 1) }} as def_reb_pct_lag_1g,
        {{ calculate_rolling_avg('reb_pct', 'team_id', 'game_date') }} as reb_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('reb_pct', 'team_id', 'game_date') }} as reb_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('reb_pct', 'team_id', 'game_date', 1) }} as reb_pct_lag_1g,
        {{ calculate_rolling_avg('est_team_tov_pct', 'team_id', 'game_date') }} as est_team_tov_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('est_team_tov_pct', 'team_id', 'game_date') }} as est_team_tov_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('est_team_tov_pct', 'team_id', 'game_date', 1) }} as est_team_tov_pct_lag_1g,
        {{ calculate_rolling_avg('tov_ratio', 'team_id', 'game_date') }} as tov_ratio_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('tov_ratio', 'team_id', 'game_date') }} as tov_ratio_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('tov_ratio', 'team_id', 'game_date', 1) }} as tov_ratio_lag_1g,
        {{ calculate_rolling_avg('eff_fg_pct', 'team_id', 'game_date') }} as eff_fg_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('eff_fg_pct', 'team_id', 'game_date') }} as eff_fg_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('eff_fg_pct', 'team_id', 'game_date', 1) }} as eff_fg_pct_lag_1g,
        {{ calculate_rolling_avg('ts_pct', 'team_id', 'game_date') }} as ts_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('ts_pct', 'team_id', 'game_date') }} as ts_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('ts_pct', 'team_id', 'game_date', 1) }} as ts_pct_lag_1g,
        {{ calculate_rolling_avg('usage_pct', 'team_id', 'game_date') }} as usage_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('usage_pct', 'team_id', 'game_date') }} as usage_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('usage_pct', 'team_id', 'game_date', 1) }} as usage_pct_lag_1g,
        {{ calculate_rolling_avg('est_usage_pct', 'team_id', 'game_date') }} as est_usage_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('est_usage_pct', 'team_id', 'game_date') }} as est_usage_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('est_usage_pct', 'team_id', 'game_date', 1) }} as est_usage_pct_lag_1g,
        {{ calculate_rolling_avg('est_pace', 'team_id', 'game_date') }} as est_pace_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('est_pace', 'team_id', 'game_date') }} as est_pace_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('est_pace', 'team_id', 'game_date', 1) }} as est_pace_lag_1g,
        {{ calculate_rolling_avg('pace', 'team_id', 'game_date') }} as pace_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pace', 'team_id', 'game_date') }} as pace_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pace', 'team_id', 'game_date', 1) }} as pace_lag_1g,
        {{ calculate_rolling_avg('pace_per_40', 'team_id', 'game_date') }} as pace_per_40_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pace_per_40', 'team_id', 'game_date') }} as pace_per_40_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pace_per_40', 'team_id', 'game_date', 1) }} as pace_per_40_lag_1g,
        {{ calculate_rolling_avg('possessions', 'team_id', 'game_date') }} as possessions_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('possessions', 'team_id', 'game_date') }} as possessions_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('possessions', 'team_id', 'game_date', 1) }} as possessions_lag_1g,
        {{ calculate_rolling_avg('pie', 'team_id', 'game_date') }} as pie_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pie', 'team_id', 'game_date') }} as pie_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pie', 'team_id', 'game_date', 1) }} as pie_lag_1g,

        -- Hustle
        {{ calculate_rolling_avg('cont_shots', 'team_id', 'game_date') }} as cont_shots_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('cont_shots', 'team_id', 'game_date') }} as cont_shots_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('cont_shots', 'team_id', 'game_date', 1) }} as cont_shots_lag_1g,
        {{ calculate_rolling_avg('cont_2pt', 'team_id', 'game_date') }} as cont_2pt_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('cont_2pt', 'team_id', 'game_date') }} as cont_2pt_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('cont_2pt', 'team_id', 'game_date', 1) }} as cont_2pt_lag_1g,
        {{ calculate_rolling_avg('cont_3pt', 'team_id', 'game_date') }} as cont_3pt_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('cont_3pt', 'team_id', 'game_date') }} as cont_3pt_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('cont_3pt', 'team_id', 'game_date', 1) }} as cont_3pt_lag_1g,
        {{ calculate_rolling_avg('deflections', 'team_id', 'game_date') }} as deflections_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('deflections', 'team_id', 'game_date') }} as deflections_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('deflections', 'team_id', 'game_date', 1) }} as deflections_lag_1g,
        {{ calculate_rolling_avg('charges_drawn', 'team_id', 'game_date') }} as charges_drawn_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('charges_drawn', 'team_id', 'game_date') }} as charges_drawn_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('charges_drawn', 'team_id', 'game_date', 1) }} as charges_drawn_lag_1g,
        {{ calculate_rolling_avg('screen_ast', 'team_id', 'game_date') }} as screen_ast_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('screen_ast', 'team_id', 'game_date') }} as screen_ast_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('screen_ast', 'team_id', 'game_date', 1) }} as screen_ast_lag_1g,
        {{ calculate_rolling_avg('screen_ast_pts', 'team_id', 'game_date') }} as screen_ast_pts_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('screen_ast_pts', 'team_id', 'game_date') }} as screen_ast_pts_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('screen_ast_pts', 'team_id', 'game_date', 1) }} as screen_ast_pts_lag_1g,
        {{ calculate_rolling_avg('off_loose_balls_rec', 'team_id', 'game_date') }} as off_loose_balls_rec_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('off_loose_balls_rec', 'team_id', 'game_date') }} as off_loose_balls_rec_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('off_loose_balls_rec', 'team_id', 'game_date', 1) }} as off_loose_balls_rec_lag_1g,
        {{ calculate_rolling_avg('def_loose_balls_rec', 'team_id', 'game_date') }} as def_loose_balls_rec_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('def_loose_balls_rec', 'team_id', 'game_date') }} as def_loose_balls_rec_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('def_loose_balls_rec', 'team_id', 'game_date', 1) }} as def_loose_balls_rec_lag_1g,
        {{ calculate_rolling_avg('tot_loose_balls_rec', 'team_id', 'game_date') }} as tot_loose_balls_rec_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('tot_loose_balls_rec', 'team_id', 'game_date') }} as tot_loose_balls_rec_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('tot_loose_balls_rec', 'team_id', 'game_date', 1) }} as tot_loose_balls_rec_lag_1g,
        {{ calculate_rolling_avg('off_box_outs', 'team_id', 'game_date') }} as off_box_outs_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('off_box_outs', 'team_id', 'game_date') }} as off_box_outs_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('off_box_outs', 'team_id', 'game_date', 1) }} as off_box_outs_lag_1g,
        {{ calculate_rolling_avg('def_box_outs', 'team_id', 'game_date') }} as def_box_outs_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('def_box_outs', 'team_id', 'game_date') }} as def_box_outs_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('def_box_outs', 'team_id', 'game_date', 1) }} as def_box_outs_lag_1g,
        {{ calculate_rolling_avg('box_out_team_reb', 'team_id', 'game_date') }} as box_out_team_reb_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('box_out_team_reb', 'team_id', 'game_date') }} as box_out_team_reb_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('box_out_team_reb', 'team_id', 'game_date', 1) }} as box_out_team_reb_lag_1g,
        {{ calculate_rolling_avg('box_out_player_reb', 'team_id', 'game_date') }} as box_out_player_reb_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('box_out_player_reb', 'team_id', 'game_date') }} as box_out_player_reb_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('box_out_player_reb', 'team_id', 'game_date', 1) }} as box_out_player_reb_lag_1g,
        {{ calculate_rolling_avg('tot_box_outs', 'team_id', 'game_date') }} as tot_box_outs_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('tot_box_outs', 'team_id', 'game_date') }} as tot_box_outs_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('tot_box_outs', 'team_id', 'game_date', 1) }} as tot_box_outs_lag_1g,

        -- Misc
        {{ calculate_rolling_avg('pts_off_tov', 'team_id', 'game_date') }} as pts_off_tov_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pts_off_tov', 'team_id', 'game_date') }} as pts_off_tov_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pts_off_tov', 'team_id', 'game_date', 1) }} as pts_off_tov_lag_1g,
        {{ calculate_rolling_avg('second_chance_pts', 'team_id', 'game_date') }} as second_chance_pts_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('second_chance_pts', 'team_id', 'game_date') }} as second_chance_pts_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('second_chance_pts', 'team_id', 'game_date', 1) }} as second_chance_pts_lag_1g,
        {{ calculate_rolling_avg('fastbreak_pts', 'team_id', 'game_date') }} as fastbreak_pts_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('fastbreak_pts', 'team_id', 'game_date') }} as fastbreak_pts_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('fastbreak_pts', 'team_id', 'game_date', 1) }} as fastbreak_pts_lag_1g,
        {{ calculate_rolling_avg('pts_in_paint', 'team_id', 'game_date') }} as pts_in_paint_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pts_in_paint', 'team_id', 'game_date') }} as pts_in_paint_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pts_in_paint', 'team_id', 'game_date', 1) }} as pts_in_paint_lag_1g,
        {{ calculate_rolling_avg('opp_pts_off_tov', 'team_id', 'game_date') }} as opp_pts_off_tov_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('opp_pts_off_tov', 'team_id', 'game_date') }} as opp_pts_off_tov_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('opp_pts_off_tov', 'team_id', 'game_date', 1) }} as opp_pts_off_tov_lag_1g,
        {{ calculate_rolling_avg('opp_second_chance_pts', 'team_id', 'game_date') }} as opp_second_chance_pts_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('opp_second_chance_pts', 'team_id', 'game_date') }} as opp_second_chance_pts_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('opp_second_chance_pts', 'team_id', 'game_date', 1) }} as opp_second_chance_pts_lag_1g,
        {{ calculate_rolling_avg('opp_fastbreak_pts', 'team_id', 'game_date') }} as opp_fastbreak_pts_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('opp_fastbreak_pts', 'team_id', 'game_date') }} as opp_fastbreak_pts_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('opp_fastbreak_pts', 'team_id', 'game_date', 1) }} as opp_fastbreak_pts_lag_1g,
        {{ calculate_rolling_avg('opp_pts_in_paint', 'team_id', 'game_date') }} as opp_pts_in_paint_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('opp_pts_in_paint', 'team_id', 'game_date') }} as opp_pts_in_paint_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('opp_pts_in_paint', 'team_id', 'game_date', 1) }} as opp_pts_in_paint_lag_1g,

        -- Scoring
        {{ calculate_rolling_avg('pct_fga_2pt', 'team_id', 'game_date') }} as pct_fga_2pt_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_fga_2pt', 'team_id', 'game_date') }} as pct_fga_2pt_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_fga_2pt', 'team_id', 'game_date', 1) }} as pct_fga_2pt_lag_1g,
        {{ calculate_rolling_avg('pct_fga_3pt', 'team_id', 'game_date') }} as pct_fga_3pt_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_fga_3pt', 'team_id', 'game_date') }} as pct_fga_3pt_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_fga_3pt', 'team_id', 'game_date', 1) }} as pct_fga_3pt_lag_1g,
        {{ calculate_rolling_avg('pct_pts_2pt', 'team_id', 'game_date') }} as pct_pts_2pt_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_pts_2pt', 'team_id', 'game_date') }} as pct_pts_2pt_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_pts_2pt', 'team_id', 'game_date', 1) }} as pct_pts_2pt_lag_1g,
        {{ calculate_rolling_avg('pct_pts_midrange_2pt', 'team_id', 'game_date') }} as pct_pts_midrange_2pt_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_pts_midrange_2pt', 'team_id', 'game_date') }} as pct_pts_midrange_2pt_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_pts_midrange_2pt', 'team_id', 'game_date', 1) }} as pct_pts_midrange_2pt_lag_1g,
        {{ calculate_rolling_avg('pct_pts_3pt', 'team_id', 'game_date') }} as pct_pts_3pt_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_pts_3pt', 'team_id', 'game_date') }} as pct_pts_3pt_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_pts_3pt', 'team_id', 'game_date', 1) }} as pct_pts_3pt_lag_1g,
        {{ calculate_rolling_avg('pct_pts_fastbreak', 'team_id', 'game_date') }} as pct_pts_fastbreak_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_pts_fastbreak', 'team_id', 'game_date') }} as pct_pts_fastbreak_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_pts_fastbreak', 'team_id', 'game_date', 1) }} as pct_pts_fastbreak_lag_1g,
        {{ calculate_rolling_avg('pct_pts_ft', 'team_id', 'game_date') }} as pct_pts_ft_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_pts_ft', 'team_id', 'game_date') }} as pct_pts_ft_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_pts_ft', 'team_id', 'game_date', 1) }} as pct_pts_ft_lag_1g,
        {{ calculate_rolling_avg('pct_pts_off_tov', 'team_id', 'game_date') }} as pct_pts_off_tov_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_pts_off_tov', 'team_id', 'game_date') }} as pct_pts_off_tov_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_pts_off_tov', 'team_id', 'game_date', 1) }} as pct_pts_off_tov_lag_1g,
        {{ calculate_rolling_avg('pct_pts_in_paint', 'team_id', 'game_date') }} as pct_pts_in_paint_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_pts_in_paint', 'team_id', 'game_date') }} as pct_pts_in_paint_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_pts_in_paint', 'team_id', 'game_date', 1) }} as pct_pts_in_paint_lag_1g,
        {{ calculate_rolling_avg('pct_assisted_2pt', 'team_id', 'game_date') }} as pct_assisted_2pt_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_assisted_2pt', 'team_id', 'game_date') }} as pct_assisted_2pt_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_assisted_2pt', 'team_id', 'game_date', 1) }} as pct_assisted_2pt_lag_1g,
        {{ calculate_rolling_avg('pct_unassisted_2pt', 'team_id', 'game_date') }} as pct_unassisted_2pt_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_unassisted_2pt', 'team_id', 'game_date') }} as pct_unassisted_2pt_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_unassisted_2pt', 'team_id', 'game_date', 1) }} as pct_unassisted_2pt_lag_1g,
        {{ calculate_rolling_avg('pct_assisted_3pt', 'team_id', 'game_date') }} as pct_assisted_3pt_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_assisted_3pt', 'team_id', 'game_date') }} as pct_assisted_3pt_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_assisted_3pt', 'team_id', 'game_date', 1) }} as pct_assisted_3pt_lag_1g,
        {{ calculate_rolling_avg('pct_unassisted_3pt', 'team_id', 'game_date') }} as pct_unassisted_3pt_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_unassisted_3pt', 'team_id', 'game_date') }} as pct_unassisted_3pt_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_unassisted_3pt', 'team_id', 'game_date', 1) }} as pct_unassisted_3pt_lag_1g,
        {{ calculate_rolling_avg('pct_assisted_fgm', 'team_id', 'game_date') }} as pct_assisted_fgm_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_assisted_fgm', 'team_id', 'game_date') }} as pct_assisted_fgm_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_assisted_fgm', 'team_id', 'game_date', 1) }} as pct_assisted_fgm_lag_1g,
        {{ calculate_rolling_avg('pct_unassisted_fgm', 'team_id', 'game_date') }} as pct_unassisted_fgm_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_unassisted_fgm', 'team_id', 'game_date') }} as pct_unassisted_fgm_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_unassisted_fgm', 'team_id', 'game_date', 1) }} as pct_unassisted_fgm_lag_1g,

        -- Timestamps for Incremental
        boxscores.updated_at

    from boxscores
)

select *
from final
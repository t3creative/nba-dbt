{{ config(
    materialized='incremental',
    unique_key='player_game_key',
    incremental_strategy='delete+insert',
    tags=['intermediate', 'stats'],
    indexes=[
        {'columns': ['player_game_key'], 'unique': True},
        {'columns': ['game_id']},
        {'columns': ['player_id']},
        {'columns': ['team_id']},
        {'columns': ['opponent_id']},
        {'columns': ['game_date']},
        {'columns': ['season_year']}
    ]
)
}}

{% set rolling_window_games = var('rolling_window_games', 10) %}

with boxscores as (
    select
        -- Identifiers & Metadata
        player_game_key,
        game_id,
        player_id,
        team_id,
        opponent_id,
        game_date,
        season_year,

        -- Traditional Boxscore Stats
        min,
        pts,
        fgm,
        fga,
        fg_pct,
        fg3m,
        fg3a,
        fg3_pct,
        ftm,
        fta,
        ft_pct,
        reb,
        off_reb,
        def_reb,
        ast,
        stl,
        blk,
        tov,
        pf,
        plus_minus,

        -- Advanced Boxscore Stats
        est_off_rating,
        off_rating,
        est_def_rating,
        def_rating,
        est_net_rating,
        net_rating,
        ast_pct,
        ast_to_tov_ratio,
        ast_ratio,
        off_reb_pct,
        def_reb_pct,
        reb_pct,
        tov_ratio,
        eff_fg_pct,
        ts_pct,
        usage_pct,
        est_usage_pct,
        est_pace,
        pace,
        pace_per_40,
        possessions,
        pie,

        -- Hustle Boxscore Stats
        cont_shots,
        cont_2pt,
        cont_3pt,
        deflections,
        charges_drawn,
        screen_ast,
        screen_ast_pts,
        off_loose_balls_rec,
        def_loose_balls_rec,
        tot_loose_balls_rec,
        off_box_outs,
        def_box_outs,
        box_out_player_reb,
        box_out_team_reb,
        tot_box_outs,

        -- Misc Boxscore Stats
        pts_off_tov,
        second_chance_pts,
        fastbreak_pts,
        pts_in_paint,
        opp_pts_off_tov_while_on,
        opp_second_chance_pts_while_on,
        opp_fastbreak_pts_while_on,
        opp_pts_in_paint_while_on,
        blk_against,
        fouls_drawn,

        -- Scoring Boxscore Stats
        pct_fga_2pt,
        pct_fga_3pt,
        pct_pts_2pt,
        pct_pts_midrange_2pt,
        pct_pts_3pt,
        pct_pts_fastbreak,
        pct_pts_ft,
        pct_pts_off_tov,
        pct_pts_in_paint,
        pct_assisted_2pt,
        pct_unassisted_2pt,
        pct_assisted_3pt,
        pct_unassisted_3pt,
        pct_assisted_fgm,
        pct_unassisted_fgm,

        -- Tracking Boxscore Stats
        distance,
        speed,
        touches,
        off_reb_chances,
        def_reb_chances,
        reb_chances,
        cont_fgm,
        cont_fga,
        cont_fg_pct,
        uncont_fgm,
        uncont_fga,
        uncont_fg_pct,
        def_at_rim_fgm,
        def_at_rim_fga,
        def_at_rim_fg_pct,

        -- Usage Boxscore Stats
        pct_of_team_fgm,
        pct_of_team_fga,
        pct_of_team_fg3m,
        pct_of_team_fg3a,
        pct_of_team_ftm,
        pct_of_team_fta,
        pct_of_team_oreb,
        pct_of_team_dreb,
        pct_of_team_reb,
        pct_of_team_ast,
        pct_of_team_tov,
        pct_of_team_stl,
        pct_of_team_blk,
        pct_of_team_blk_allowed,
        pct_of_team_pf,
        pct_of_team_pfd,
        pct_of_team_pts,

        -- Defensive Boxscore Stats
        matchup_min,
        partial_poss,
        def_switches,
        pts_allowed,
        ast_allowed,
        tov_forced,
        matchup_fgm,
        matchup_fga,
        matchup_fg_pct,
        matchup_fg3m,
        matchup_fg3a,
        matchup_fg3_pct,

        -- Timestamps for Incremental
        updated_at

    from {{ ref('int__player_boxscores') }}
    {% if is_incremental() %}
    -- Look back N+1 days to ensure rolling calculations are correct near the incremental boundary
    where game_date >= (
        select max(game_date) - interval '{{ rolling_window_games + 1 }} days'
        from {{ this }}
    )
    {% endif %}
),

final as (
    select
        -- Identifiers & Metadata
        player_game_key,
        game_id,
        player_id,
        team_id,
        opponent_id,
        game_date,
        season_year,

        -- Calculate rolling average, stddev, and lag for each specified stat

        -- Traditional Boxscore Stats
        {{ calculate_rolling_avg('min', 'player_id', 'game_date') }} as min_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('min', 'player_id', 'game_date') }} as min_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('min', 'player_id', 'game_date', 1) }} as min_lag_1g,
        {{ calculate_rolling_avg('pts', 'player_id', 'game_date') }} as pts_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pts', 'player_id', 'game_date') }} as pts_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pts', 'player_id', 'game_date', 1) }} as pts_lag_1g,
        {{ calculate_rolling_avg('fgm', 'player_id', 'game_date') }} as fgm_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('fgm', 'player_id', 'game_date') }} as fgm_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('fgm', 'player_id', 'game_date', 1) }} as fgm_lag_1g,
        {{ calculate_rolling_avg('fga', 'player_id', 'game_date') }} as fga_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('fga', 'player_id', 'game_date') }} as fga_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('fga', 'player_id', 'game_date', 1) }} as fga_lag_1g,
        {{ calculate_rolling_avg('fg_pct', 'player_id', 'game_date') }} as fg_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('fg_pct', 'player_id', 'game_date') }} as fg_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('fg_pct', 'player_id', 'game_date', 1) }} as fg_pct_lag_1g,
        {{ calculate_rolling_avg('fg3m', 'player_id', 'game_date') }} as fg3m_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('fg3m', 'player_id', 'game_date') }} as fg3m_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('fg3m', 'player_id', 'game_date', 1) }} as fg3m_lag_1g,
        {{ calculate_rolling_avg('fg3a', 'player_id', 'game_date') }} as fg3a_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('fg3a', 'player_id', 'game_date') }} as fg3a_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('fg3a', 'player_id', 'game_date', 1) }} as fg3a_lag_1g,
        {{ calculate_rolling_avg('fg3_pct', 'player_id', 'game_date') }} as fg3_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('fg3_pct', 'player_id', 'game_date') }} as fg3_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('fg3_pct', 'player_id', 'game_date', 1) }} as fg3_pct_lag_1g,
        {{ calculate_rolling_avg('ftm', 'player_id', 'game_date') }} as ftm_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('ftm', 'player_id', 'game_date') }} as ftm_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('ftm', 'player_id', 'game_date', 1) }} as ftm_lag_1g,
        {{ calculate_rolling_avg('fta', 'player_id', 'game_date') }} as fta_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('fta', 'player_id', 'game_date') }} as fta_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('fta', 'player_id', 'game_date', 1) }} as fta_lag_1g,
        {{ calculate_rolling_avg('ft_pct', 'player_id', 'game_date') }} as ft_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('ft_pct', 'player_id', 'game_date') }} as ft_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('ft_pct', 'player_id', 'game_date', 1) }} as ft_pct_lag_1g,
        {{ calculate_rolling_avg('reb', 'player_id', 'game_date') }} as reb_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('reb', 'player_id', 'game_date') }} as reb_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('reb', 'player_id', 'game_date', 1) }} as reb_lag_1g,
        {{ calculate_rolling_avg('off_reb', 'player_id', 'game_date') }} as off_reb_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('off_reb', 'player_id', 'game_date') }} as off_reb_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('off_reb', 'player_id', 'game_date', 1) }} as off_reb_lag_1g,
        {{ calculate_rolling_avg('def_reb', 'player_id', 'game_date') }} as def_reb_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('def_reb', 'player_id', 'game_date') }} as def_reb_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('def_reb', 'player_id', 'game_date', 1) }} as def_reb_lag_1g,
        {{ calculate_rolling_avg('ast', 'player_id', 'game_date') }} as ast_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('ast', 'player_id', 'game_date') }} as ast_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('ast', 'player_id', 'game_date', 1) }} as ast_lag_1g,
        {{ calculate_rolling_avg('stl', 'player_id', 'game_date') }} as stl_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('stl', 'player_id', 'game_date') }} as stl_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('stl', 'player_id', 'game_date', 1) }} as stl_lag_1g,
        {{ calculate_rolling_avg('blk', 'player_id', 'game_date') }} as blk_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('blk', 'player_id', 'game_date') }} as blk_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('blk', 'player_id', 'game_date', 1) }} as blk_lag_1g,
        {{ calculate_rolling_avg('tov', 'player_id', 'game_date') }} as tov_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('tov', 'player_id', 'game_date') }} as tov_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('tov', 'player_id', 'game_date', 1) }} as tov_lag_1g,
        {{ calculate_rolling_avg('pf', 'player_id', 'game_date') }} as pf_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pf', 'player_id', 'game_date') }} as pf_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pf', 'player_id', 'game_date', 1) }} as pf_lag_1g,
        {{ calculate_rolling_avg('plus_minus', 'player_id', 'game_date') }} as plus_minus_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('plus_minus', 'player_id', 'game_date') }} as plus_minus_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('plus_minus', 'player_id', 'game_date', 1) }} as plus_minus_lag_1g,

        -- Advanced Boxscore Stats
        {{ calculate_rolling_avg('est_off_rating', 'player_id', 'game_date') }} as est_off_rating_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('est_off_rating', 'player_id', 'game_date') }} as est_off_rating_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('est_off_rating', 'player_id', 'game_date', 1) }} as est_off_rating_lag_1g,
        {{ calculate_rolling_avg('off_rating', 'player_id', 'game_date') }} as off_rating_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('off_rating', 'player_id', 'game_date') }} as off_rating_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('off_rating', 'player_id', 'game_date', 1) }} as off_rating_lag_1g,
        {{ calculate_rolling_avg('est_def_rating', 'player_id', 'game_date') }} as est_def_rating_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('est_def_rating', 'player_id', 'game_date') }} as est_def_rating_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('est_def_rating', 'player_id', 'game_date', 1) }} as est_def_rating_lag_1g,
        {{ calculate_rolling_avg('def_rating', 'player_id', 'game_date') }} as def_rating_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('def_rating', 'player_id', 'game_date') }} as def_rating_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('def_rating', 'player_id', 'game_date', 1) }} as def_rating_lag_1g,
        {{ calculate_rolling_avg('est_net_rating', 'player_id', 'game_date') }} as est_net_rating_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('est_net_rating', 'player_id', 'game_date') }} as est_net_rating_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('est_net_rating', 'player_id', 'game_date', 1) }} as est_net_rating_lag_1g,
        {{ calculate_rolling_avg('net_rating', 'player_id', 'game_date') }} as net_rating_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('net_rating', 'player_id', 'game_date') }} as net_rating_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('net_rating', 'player_id', 'game_date', 1) }} as net_rating_lag_1g,
        {{ calculate_rolling_avg('ast_pct', 'player_id', 'game_date') }} as ast_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('ast_pct', 'player_id', 'game_date') }} as ast_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('ast_pct', 'player_id', 'game_date', 1) }} as ast_pct_lag_1g,
        {{ calculate_rolling_avg('ast_to_tov_ratio', 'player_id', 'game_date') }} as ast_to_tov_ratio_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('ast_to_tov_ratio', 'player_id', 'game_date') }} as ast_to_tov_ratio_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('ast_to_tov_ratio', 'player_id', 'game_date', 1) }} as ast_to_tov_ratio_lag_1g,
        {{ calculate_rolling_avg('ast_ratio', 'player_id', 'game_date') }} as ast_ratio_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('ast_ratio', 'player_id', 'game_date') }} as ast_ratio_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('ast_ratio', 'player_id', 'game_date', 1) }} as ast_ratio_lag_1g,
        {{ calculate_rolling_avg('off_reb_pct', 'player_id', 'game_date') }} as off_reb_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('off_reb_pct', 'player_id', 'game_date') }} as off_reb_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('off_reb_pct', 'player_id', 'game_date', 1) }} as off_reb_pct_lag_1g,
        {{ calculate_rolling_avg('def_reb_pct', 'player_id', 'game_date') }} as def_reb_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('def_reb_pct', 'player_id', 'game_date') }} as def_reb_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('def_reb_pct', 'player_id', 'game_date', 1) }} as def_reb_pct_lag_1g,
        {{ calculate_rolling_avg('reb_pct', 'player_id', 'game_date') }} as reb_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('reb_pct', 'player_id', 'game_date') }} as reb_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('reb_pct', 'player_id', 'game_date', 1) }} as reb_pct_lag_1g,
        {{ calculate_rolling_avg('tov_ratio', 'player_id', 'game_date') }} as tov_ratio_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('tov_ratio', 'player_id', 'game_date') }} as tov_ratio_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('tov_ratio', 'player_id', 'game_date', 1) }} as tov_ratio_lag_1g,
        {{ calculate_rolling_avg('eff_fg_pct', 'player_id', 'game_date') }} as eff_fg_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('eff_fg_pct', 'player_id', 'game_date') }} as eff_fg_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('eff_fg_pct', 'player_id', 'game_date', 1) }} as eff_fg_pct_lag_1g,
        {{ calculate_rolling_avg('ts_pct', 'player_id', 'game_date') }} as ts_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('ts_pct', 'player_id', 'game_date') }} as ts_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('ts_pct', 'player_id', 'game_date', 1) }} as ts_pct_lag_1g,
        {{ calculate_rolling_avg('usage_pct', 'player_id', 'game_date') }} as usage_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('usage_pct', 'player_id', 'game_date') }} as usage_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('usage_pct', 'player_id', 'game_date', 1) }} as usage_pct_lag_1g,
        {{ calculate_rolling_avg('est_usage_pct', 'player_id', 'game_date') }} as est_usage_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('est_usage_pct', 'player_id', 'game_date') }} as est_usage_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('est_usage_pct', 'player_id', 'game_date', 1) }} as est_usage_pct_lag_1g,
        {{ calculate_rolling_avg('est_pace', 'player_id', 'game_date') }} as est_pace_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('est_pace', 'player_id', 'game_date') }} as est_pace_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('est_pace', 'player_id', 'game_date', 1) }} as est_pace_lag_1g,
        {{ calculate_rolling_avg('pace', 'player_id', 'game_date') }} as pace_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pace', 'player_id', 'game_date') }} as pace_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pace', 'player_id', 'game_date', 1) }} as pace_lag_1g,
        {{ calculate_rolling_avg('pace_per_40', 'player_id', 'game_date') }} as pace_per_40_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pace_per_40', 'player_id', 'game_date') }} as pace_per_40_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pace_per_40', 'player_id', 'game_date', 1) }} as pace_per_40_lag_1g,
        {{ calculate_rolling_avg('possessions', 'player_id', 'game_date') }} as possessions_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('possessions', 'player_id', 'game_date') }} as possessions_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('possessions', 'player_id', 'game_date', 1) }} as possessions_lag_1g,
        {{ calculate_rolling_avg('pie', 'player_id', 'game_date') }} as pie_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pie', 'player_id', 'game_date') }} as pie_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pie', 'player_id', 'game_date', 1) }} as pie_lag_1g,

        -- Hustle Boxscore Stats
        {{ calculate_rolling_avg('cont_shots', 'player_id', 'game_date') }} as cont_shots_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('cont_shots', 'player_id', 'game_date') }} as cont_shots_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('cont_shots', 'player_id', 'game_date', 1) }} as cont_shots_lag_1g,
        {{ calculate_rolling_avg('cont_2pt', 'player_id', 'game_date') }} as cont_2pt_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('cont_2pt', 'player_id', 'game_date') }} as cont_2pt_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('cont_2pt', 'player_id', 'game_date', 1) }} as cont_2pt_lag_1g,
        {{ calculate_rolling_avg('cont_3pt', 'player_id', 'game_date') }} as cont_3pt_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('cont_3pt', 'player_id', 'game_date') }} as cont_3pt_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('cont_3pt', 'player_id', 'game_date', 1) }} as cont_3pt_lag_1g,
        {{ calculate_rolling_avg('deflections', 'player_id', 'game_date') }} as deflections_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('deflections', 'player_id', 'game_date') }} as deflections_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('deflections', 'player_id', 'game_date', 1) }} as deflections_lag_1g,
        {{ calculate_rolling_avg('charges_drawn', 'player_id', 'game_date') }} as charges_drawn_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('charges_drawn', 'player_id', 'game_date') }} as charges_drawn_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('charges_drawn', 'player_id', 'game_date', 1) }} as charges_drawn_lag_1g,
        {{ calculate_rolling_avg('screen_ast', 'player_id', 'game_date') }} as screen_ast_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('screen_ast', 'player_id', 'game_date') }} as screen_ast_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('screen_ast', 'player_id', 'game_date', 1) }} as screen_ast_lag_1g,
        {{ calculate_rolling_avg('screen_ast_pts', 'player_id', 'game_date') }} as screen_ast_pts_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('screen_ast_pts', 'player_id', 'game_date') }} as screen_ast_pts_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('screen_ast_pts', 'player_id', 'game_date', 1) }} as screen_ast_pts_lag_1g,
        {{ calculate_rolling_avg('off_loose_balls_rec', 'player_id', 'game_date') }} as off_loose_balls_rec_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('off_loose_balls_rec', 'player_id', 'game_date') }} as off_loose_balls_rec_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('off_loose_balls_rec', 'player_id', 'game_date', 1) }} as off_loose_balls_rec_lag_1g,
        {{ calculate_rolling_avg('def_loose_balls_rec', 'player_id', 'game_date') }} as def_loose_balls_rec_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('def_loose_balls_rec', 'player_id', 'game_date') }} as def_loose_balls_rec_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('def_loose_balls_rec', 'player_id', 'game_date', 1) }} as def_loose_balls_rec_lag_1g,
        {{ calculate_rolling_avg('tot_loose_balls_rec', 'player_id', 'game_date') }} as tot_loose_balls_rec_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('tot_loose_balls_rec', 'player_id', 'game_date') }} as tot_loose_balls_rec_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('tot_loose_balls_rec', 'player_id', 'game_date', 1) }} as tot_loose_balls_rec_lag_1g,
        {{ calculate_rolling_avg('off_box_outs', 'player_id', 'game_date') }} as off_box_outs_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('off_box_outs', 'player_id', 'game_date') }} as off_box_outs_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('off_box_outs', 'player_id', 'game_date', 1) }} as off_box_outs_lag_1g,
        {{ calculate_rolling_avg('def_box_outs', 'player_id', 'game_date') }} as def_box_outs_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('def_box_outs', 'player_id', 'game_date') }} as def_box_outs_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('def_box_outs', 'player_id', 'game_date', 1) }} as def_box_outs_lag_1g,
        {{ calculate_rolling_avg('box_out_player_reb', 'player_id', 'game_date') }} as box_out_player_reb_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('box_out_player_reb', 'player_id', 'game_date') }} as box_out_player_reb_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('box_out_player_reb', 'player_id', 'game_date', 1) }} as box_out_player_reb_lag_1g,
        {{ calculate_rolling_avg('box_out_team_reb', 'player_id', 'game_date') }} as box_out_team_reb_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('box_out_team_reb', 'player_id', 'game_date') }} as box_out_team_reb_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('box_out_team_reb', 'player_id', 'game_date', 1) }} as box_out_team_reb_lag_1g,
        {{ calculate_rolling_avg('tot_box_outs', 'player_id', 'game_date') }} as tot_box_outs_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('tot_box_outs', 'player_id', 'game_date') }} as tot_box_outs_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('tot_box_outs', 'player_id', 'game_date', 1) }} as tot_box_outs_lag_1g,

        -- Misc Boxscore Stats
        {{ calculate_rolling_avg('pts_off_tov', 'player_id', 'game_date') }} as pts_off_tov_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pts_off_tov', 'player_id', 'game_date') }} as pts_off_tov_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pts_off_tov', 'player_id', 'game_date', 1) }} as pts_off_tov_lag_1g,
        {{ calculate_rolling_avg('second_chance_pts', 'player_id', 'game_date') }} as second_chance_pts_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('second_chance_pts', 'player_id', 'game_date') }} as second_chance_pts_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('second_chance_pts', 'player_id', 'game_date', 1) }} as second_chance_pts_lag_1g,
        {{ calculate_rolling_avg('fastbreak_pts', 'player_id', 'game_date') }} as fastbreak_pts_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('fastbreak_pts', 'player_id', 'game_date') }} as fastbreak_pts_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('fastbreak_pts', 'player_id', 'game_date', 1) }} as fastbreak_pts_lag_1g,
        {{ calculate_rolling_avg('pts_in_paint', 'player_id', 'game_date') }} as pts_in_paint_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pts_in_paint', 'player_id', 'game_date') }} as pts_in_paint_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pts_in_paint', 'player_id', 'game_date', 1) }} as pts_in_paint_lag_1g,
        {{ calculate_rolling_avg('opp_pts_off_tov_while_on', 'player_id', 'game_date') }} as opp_pts_off_tov_while_on_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('opp_pts_off_tov_while_on', 'player_id', 'game_date') }} as opp_pts_off_tov_while_on_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('opp_pts_off_tov_while_on', 'player_id', 'game_date', 1) }} as opp_pts_off_tov_while_on_lag_1g,
        {{ calculate_rolling_avg('opp_second_chance_pts_while_on', 'player_id', 'game_date') }} as opp_second_chance_pts_while_on_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('opp_second_chance_pts_while_on', 'player_id', 'game_date') }} as opp_second_chance_pts_while_on_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('opp_second_chance_pts_while_on', 'player_id', 'game_date', 1) }} as opp_second_chance_pts_while_on_lag_1g,
        {{ calculate_rolling_avg('opp_fastbreak_pts_while_on', 'player_id', 'game_date') }} as opp_fastbreak_pts_while_on_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('opp_fastbreak_pts_while_on', 'player_id', 'game_date') }} as opp_fastbreak_pts_while_on_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('opp_fastbreak_pts_while_on', 'player_id', 'game_date', 1) }} as opp_fastbreak_pts_while_on_lag_1g,
        {{ calculate_rolling_avg('opp_pts_in_paint_while_on', 'player_id', 'game_date') }} as opp_pts_in_paint_while_on_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('opp_pts_in_paint_while_on', 'player_id', 'game_date') }} as opp_pts_in_paint_while_on_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('opp_pts_in_paint_while_on', 'player_id', 'game_date', 1) }} as opp_pts_in_paint_while_on_lag_1g,
        {{ calculate_rolling_avg('blk_against', 'player_id', 'game_date') }} as blk_against_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('blk_against', 'player_id', 'game_date') }} as blk_against_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('blk_against', 'player_id', 'game_date', 1) }} as blk_against_lag_1g,
        {{ calculate_rolling_avg('fouls_drawn', 'player_id', 'game_date') }} as fouls_drawn_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('fouls_drawn', 'player_id', 'game_date') }} as fouls_drawn_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('fouls_drawn', 'player_id', 'game_date', 1) }} as fouls_drawn_lag_1g,

        -- Scoring Boxscore Stats
        {{ calculate_rolling_avg('pct_fga_2pt', 'player_id', 'game_date') }} as pct_fga_2pt_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_fga_2pt', 'player_id', 'game_date') }} as pct_fga_2pt_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_fga_2pt', 'player_id', 'game_date', 1) }} as pct_fga_2pt_lag_1g,
        {{ calculate_rolling_avg('pct_fga_3pt', 'player_id', 'game_date') }} as pct_fga_3pt_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_fga_3pt', 'player_id', 'game_date') }} as pct_fga_3pt_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_fga_3pt', 'player_id', 'game_date', 1) }} as pct_fga_3pt_lag_1g,
        {{ calculate_rolling_avg('pct_pts_2pt', 'player_id', 'game_date') }} as pct_pts_2pt_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_pts_2pt', 'player_id', 'game_date') }} as pct_pts_2pt_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_pts_2pt', 'player_id', 'game_date', 1) }} as pct_pts_2pt_lag_1g,
        {{ calculate_rolling_avg('pct_pts_midrange_2pt', 'player_id', 'game_date') }} as pct_pts_midrange_2pt_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_pts_midrange_2pt', 'player_id', 'game_date') }} as pct_pts_midrange_2pt_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_pts_midrange_2pt', 'player_id', 'game_date', 1) }} as pct_pts_midrange_2pt_lag_1g,
        {{ calculate_rolling_avg('pct_pts_3pt', 'player_id', 'game_date') }} as pct_pts_3pt_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_pts_3pt', 'player_id', 'game_date') }} as pct_pts_3pt_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_pts_3pt', 'player_id', 'game_date', 1) }} as pct_pts_3pt_lag_1g,
        {{ calculate_rolling_avg('pct_pts_fastbreak', 'player_id', 'game_date') }} as pct_pts_fastbreak_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_pts_fastbreak', 'player_id', 'game_date') }} as pct_pts_fastbreak_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_pts_fastbreak', 'player_id', 'game_date', 1) }} as pct_pts_fastbreak_lag_1g,
        {{ calculate_rolling_avg('pct_pts_ft', 'player_id', 'game_date') }} as pct_pts_ft_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_pts_ft', 'player_id', 'game_date') }} as pct_pts_ft_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_pts_ft', 'player_id', 'game_date', 1) }} as pct_pts_ft_lag_1g,
        {{ calculate_rolling_avg('pct_pts_off_tov', 'player_id', 'game_date') }} as pct_pts_off_tov_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_pts_off_tov', 'player_id', 'game_date') }} as pct_pts_off_tov_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_pts_off_tov', 'player_id', 'game_date', 1) }} as pct_pts_off_tov_lag_1g,
        {{ calculate_rolling_avg('pct_pts_in_paint', 'player_id', 'game_date') }} as pct_pts_in_paint_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_pts_in_paint', 'player_id', 'game_date') }} as pct_pts_in_paint_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_pts_in_paint', 'player_id', 'game_date', 1) }} as pct_pts_in_paint_lag_1g,
        {{ calculate_rolling_avg('pct_assisted_2pt', 'player_id', 'game_date') }} as pct_assisted_2pt_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_assisted_2pt', 'player_id', 'game_date') }} as pct_assisted_2pt_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_assisted_2pt', 'player_id', 'game_date', 1) }} as pct_assisted_2pt_lag_1g,
        {{ calculate_rolling_avg('pct_unassisted_2pt', 'player_id', 'game_date') }} as pct_unassisted_2pt_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_unassisted_2pt', 'player_id', 'game_date') }} as pct_unassisted_2pt_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_unassisted_2pt', 'player_id', 'game_date', 1) }} as pct_unassisted_2pt_lag_1g,
        {{ calculate_rolling_avg('pct_assisted_3pt', 'player_id', 'game_date') }} as pct_assisted_3pt_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_assisted_3pt', 'player_id', 'game_date') }} as pct_assisted_3pt_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_assisted_3pt', 'player_id', 'game_date', 1) }} as pct_assisted_3pt_lag_1g,
        {{ calculate_rolling_avg('pct_unassisted_3pt', 'player_id', 'game_date') }} as pct_unassisted_3pt_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_unassisted_3pt', 'player_id', 'game_date') }} as pct_unassisted_3pt_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_unassisted_3pt', 'player_id', 'game_date', 1) }} as pct_unassisted_3pt_lag_1g,
        {{ calculate_rolling_avg('pct_assisted_fgm', 'player_id', 'game_date') }} as pct_assisted_fgm_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_assisted_fgm', 'player_id', 'game_date') }} as pct_assisted_fgm_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_assisted_fgm', 'player_id', 'game_date', 1) }} as pct_assisted_fgm_lag_1g,
        {{ calculate_rolling_avg('pct_unassisted_fgm', 'player_id', 'game_date') }} as pct_unassisted_fgm_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_unassisted_fgm', 'player_id', 'game_date') }} as pct_unassisted_fgm_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_unassisted_fgm', 'player_id', 'game_date', 1) }} as pct_unassisted_fgm_lag_1g,

        -- Tracking Boxscore Stats
        {{ calculate_rolling_avg('distance', 'player_id', 'game_date') }} as distance_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('distance', 'player_id', 'game_date') }} as distance_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('distance', 'player_id', 'game_date', 1) }} as distance_lag_1g,
        {{ calculate_rolling_avg('speed', 'player_id', 'game_date') }} as speed_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('speed', 'player_id', 'game_date') }} as speed_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('speed', 'player_id', 'game_date', 1) }} as speed_lag_1g,
        {{ calculate_rolling_avg('touches', 'player_id', 'game_date') }} as touches_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('touches', 'player_id', 'game_date') }} as touches_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('touches', 'player_id', 'game_date', 1) }} as touches_lag_1g,
        {{ calculate_rolling_avg('off_reb_chances', 'player_id', 'game_date') }} as off_reb_chances_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('off_reb_chances', 'player_id', 'game_date') }} as off_reb_chances_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('off_reb_chances', 'player_id', 'game_date', 1) }} as off_reb_chances_lag_1g,
        {{ calculate_rolling_avg('def_reb_chances', 'player_id', 'game_date') }} as def_reb_chances_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('def_reb_chances', 'player_id', 'game_date') }} as def_reb_chances_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('def_reb_chances', 'player_id', 'game_date', 1) }} as def_reb_chances_lag_1g,
        {{ calculate_rolling_avg('reb_chances', 'player_id', 'game_date') }} as reb_chances_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('reb_chances', 'player_id', 'game_date') }} as reb_chances_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('reb_chances', 'player_id', 'game_date', 1) }} as reb_chances_lag_1g,
        {{ calculate_rolling_avg('cont_fgm', 'player_id', 'game_date') }} as cont_fgm_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('cont_fgm', 'player_id', 'game_date') }} as cont_fgm_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('cont_fgm', 'player_id', 'game_date', 1) }} as cont_fgm_lag_1g,
        {{ calculate_rolling_avg('cont_fga', 'player_id', 'game_date') }} as cont_fga_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('cont_fga', 'player_id', 'game_date') }} as cont_fga_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('cont_fga', 'player_id', 'game_date', 1) }} as cont_fga_lag_1g,
        {{ calculate_rolling_avg('cont_fg_pct', 'player_id', 'game_date') }} as cont_fg_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('cont_fg_pct', 'player_id', 'game_date') }} as cont_fg_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('cont_fg_pct', 'player_id', 'game_date', 1) }} as cont_fg_pct_lag_1g,
        {{ calculate_rolling_avg('uncont_fgm', 'player_id', 'game_date') }} as uncont_fgm_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('uncont_fgm', 'player_id', 'game_date') }} as uncont_fgm_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('uncont_fgm', 'player_id', 'game_date', 1) }} as uncont_fgm_lag_1g,
        {{ calculate_rolling_avg('uncont_fga', 'player_id', 'game_date') }} as uncont_fga_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('uncont_fga', 'player_id', 'game_date') }} as uncont_fga_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('uncont_fga', 'player_id', 'game_date', 1) }} as uncont_fga_lag_1g,
        {{ calculate_rolling_avg('uncont_fg_pct', 'player_id', 'game_date') }} as uncont_fg_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('uncont_fg_pct', 'player_id', 'game_date') }} as uncont_fg_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('uncont_fg_pct', 'player_id', 'game_date', 1) }} as uncont_fg_pct_lag_1g,
        {{ calculate_rolling_avg('def_at_rim_fgm', 'player_id', 'game_date') }} as def_at_rim_fgm_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('def_at_rim_fgm', 'player_id', 'game_date') }} as def_at_rim_fgm_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('def_at_rim_fgm', 'player_id', 'game_date', 1) }} as def_at_rim_fgm_lag_1g,
        {{ calculate_rolling_avg('def_at_rim_fga', 'player_id', 'game_date') }} as def_at_rim_fga_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('def_at_rim_fga', 'player_id', 'game_date') }} as def_at_rim_fga_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('def_at_rim_fga', 'player_id', 'game_date', 1) }} as def_at_rim_fga_lag_1g,
        {{ calculate_rolling_avg('def_at_rim_fg_pct', 'player_id', 'game_date') }} as def_at_rim_fg_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('def_at_rim_fg_pct', 'player_id', 'game_date') }} as def_at_rim_fg_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('def_at_rim_fg_pct', 'player_id', 'game_date', 1) }} as def_at_rim_fg_pct_lag_1g,

        -- Usage Boxscore Stats
        {{ calculate_rolling_avg('pct_of_team_fgm', 'player_id', 'game_date') }} as pct_of_team_fgm_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_of_team_fgm', 'player_id', 'game_date') }} as pct_of_team_fgm_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_of_team_fgm', 'player_id', 'game_date', 1) }} as pct_of_team_fgm_lag_1g,
        {{ calculate_rolling_avg('pct_of_team_fga', 'player_id', 'game_date') }} as pct_of_team_fga_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_of_team_fga', 'player_id', 'game_date') }} as pct_of_team_fga_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_of_team_fga', 'player_id', 'game_date', 1) }} as pct_of_team_fga_lag_1g,
        {{ calculate_rolling_avg('pct_of_team_fg3m', 'player_id', 'game_date') }} as pct_of_team_fg3m_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_of_team_fg3m', 'player_id', 'game_date') }} as pct_of_team_fg3m_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_of_team_fg3m', 'player_id', 'game_date', 1) }} as pct_of_team_fg3m_lag_1g,
        {{ calculate_rolling_avg('pct_of_team_fg3a', 'player_id', 'game_date') }} as pct_of_team_fg3a_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_of_team_fg3a', 'player_id', 'game_date') }} as pct_of_team_fg3a_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_of_team_fg3a', 'player_id', 'game_date', 1) }} as pct_of_team_fg3a_lag_1g,
        {{ calculate_rolling_avg('pct_of_team_ftm', 'player_id', 'game_date') }} as pct_of_team_ftm_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_of_team_ftm', 'player_id', 'game_date') }} as pct_of_team_ftm_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_of_team_ftm', 'player_id', 'game_date', 1) }} as pct_of_team_ftm_lag_1g,
        {{ calculate_rolling_avg('pct_of_team_fta', 'player_id', 'game_date') }} as pct_of_team_fta_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_of_team_fta', 'player_id', 'game_date') }} as pct_of_team_fta_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_of_team_fta', 'player_id', 'game_date', 1) }} as pct_of_team_fta_lag_1g,
        {{ calculate_rolling_avg('pct_of_team_oreb', 'player_id', 'game_date') }} as pct_of_team_oreb_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_of_team_oreb', 'player_id', 'game_date') }} as pct_of_team_oreb_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_of_team_oreb', 'player_id', 'game_date', 1) }} as pct_of_team_oreb_lag_1g,
        {{ calculate_rolling_avg('pct_of_team_dreb', 'player_id', 'game_date') }} as pct_of_team_dreb_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_of_team_dreb', 'player_id', 'game_date') }} as pct_of_team_dreb_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_of_team_dreb', 'player_id', 'game_date', 1) }} as pct_of_team_dreb_lag_1g,
        {{ calculate_rolling_avg('pct_of_team_reb', 'player_id', 'game_date') }} as pct_of_team_reb_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_of_team_reb', 'player_id', 'game_date') }} as pct_of_team_reb_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_of_team_reb', 'player_id', 'game_date', 1) }} as pct_of_team_reb_lag_1g,
        {{ calculate_rolling_avg('pct_of_team_ast', 'player_id', 'game_date') }} as pct_of_team_ast_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_of_team_ast', 'player_id', 'game_date') }} as pct_of_team_ast_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_of_team_ast', 'player_id', 'game_date', 1) }} as pct_of_team_ast_lag_1g,
        {{ calculate_rolling_avg('pct_of_team_tov', 'player_id', 'game_date') }} as pct_of_team_tov_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_of_team_tov', 'player_id', 'game_date') }} as pct_of_team_tov_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_of_team_tov', 'player_id', 'game_date', 1) }} as pct_of_team_tov_lag_1g,
        {{ calculate_rolling_avg('pct_of_team_stl', 'player_id', 'game_date') }} as pct_of_team_stl_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_of_team_stl', 'player_id', 'game_date') }} as pct_of_team_stl_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_of_team_stl', 'player_id', 'game_date', 1) }} as pct_of_team_stl_lag_1g,
        {{ calculate_rolling_avg('pct_of_team_blk', 'player_id', 'game_date') }} as pct_of_team_blk_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_of_team_blk', 'player_id', 'game_date') }} as pct_of_team_blk_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_of_team_blk', 'player_id', 'game_date', 1) }} as pct_of_team_blk_lag_1g,
        {{ calculate_rolling_avg('pct_of_team_blk_allowed', 'player_id', 'game_date') }} as pct_of_team_blk_allowed_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_of_team_blk_allowed', 'player_id', 'game_date') }} as pct_of_team_blk_allowed_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_of_team_blk_allowed', 'player_id', 'game_date', 1) }} as pct_of_team_blk_allowed_lag_1g,
        {{ calculate_rolling_avg('pct_of_team_pf', 'player_id', 'game_date') }} as pct_of_team_pf_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_of_team_pf', 'player_id', 'game_date') }} as pct_of_team_pf_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_of_team_pf', 'player_id', 'game_date', 1) }} as pct_of_team_pf_lag_1g,
        {{ calculate_rolling_avg('pct_of_team_pfd', 'player_id', 'game_date') }} as pct_of_team_pfd_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_of_team_pfd', 'player_id', 'game_date') }} as pct_of_team_pfd_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_of_team_pfd', 'player_id', 'game_date', 1) }} as pct_of_team_pfd_lag_1g,
        {{ calculate_rolling_avg('pct_of_team_pts', 'player_id', 'game_date') }} as pct_of_team_pts_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pct_of_team_pts', 'player_id', 'game_date') }} as pct_of_team_pts_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pct_of_team_pts', 'player_id', 'game_date', 1) }} as pct_of_team_pts_lag_1g,

        -- Defensive Boxscore Stats
        {{ calculate_rolling_avg('matchup_min', 'player_id', 'game_date') }} as matchup_min_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('matchup_min', 'player_id', 'game_date') }} as matchup_min_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('matchup_min', 'player_id', 'game_date', 1) }} as matchup_min_lag_1g,
        {{ calculate_rolling_avg('partial_poss', 'player_id', 'game_date') }} as partial_poss_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('partial_poss', 'player_id', 'game_date') }} as partial_poss_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('partial_poss', 'player_id', 'game_date', 1) }} as partial_poss_lag_1g,
        {{ calculate_rolling_avg('def_switches', 'player_id', 'game_date') }} as def_switches_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('def_switches', 'player_id', 'game_date') }} as def_switches_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('def_switches', 'player_id', 'game_date', 1) }} as def_switches_lag_1g,
        {{ calculate_rolling_avg('pts_allowed', 'player_id', 'game_date') }} as pts_allowed_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('pts_allowed', 'player_id', 'game_date') }} as pts_allowed_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('pts_allowed', 'player_id', 'game_date', 1) }} as pts_allowed_lag_1g,
        {{ calculate_rolling_avg('ast_allowed', 'player_id', 'game_date') }} as ast_allowed_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('ast_allowed', 'player_id', 'game_date') }} as ast_allowed_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('ast_allowed', 'player_id', 'game_date', 1) }} as ast_allowed_lag_1g,
        {{ calculate_rolling_avg('tov_forced', 'player_id', 'game_date') }} as tov_forced_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('tov_forced', 'player_id', 'game_date') }} as tov_forced_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('tov_forced', 'player_id', 'game_date', 1) }} as tov_forced_lag_1g,
        {{ calculate_rolling_avg('matchup_fgm', 'player_id', 'game_date') }} as matchup_fgm_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('matchup_fgm', 'player_id', 'game_date') }} as matchup_fgm_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('matchup_fgm', 'player_id', 'game_date', 1) }} as matchup_fgm_lag_1g,
        {{ calculate_rolling_avg('matchup_fga', 'player_id', 'game_date') }} as matchup_fga_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('matchup_fga', 'player_id', 'game_date') }} as matchup_fga_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('matchup_fga', 'player_id', 'game_date', 1) }} as matchup_fga_lag_1g,
        {{ calculate_rolling_avg('matchup_fg_pct', 'player_id', 'game_date') }} as matchup_fg_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('matchup_fg_pct', 'player_id', 'game_date') }} as matchup_fg_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('matchup_fg_pct', 'player_id', 'game_date', 1) }} as matchup_fg_pct_lag_1g,
        {{ calculate_rolling_avg('matchup_fg3m', 'player_id', 'game_date') }} as matchup_fg3m_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('matchup_fg3m', 'player_id', 'game_date') }} as matchup_fg3m_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('matchup_fg3m', 'player_id', 'game_date', 1) }} as matchup_fg3m_lag_1g,
        {{ calculate_rolling_avg('matchup_fg3a', 'player_id', 'game_date') }} as matchup_fg3a_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('matchup_fg3a', 'player_id', 'game_date') }} as matchup_fg3a_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('matchup_fg3a', 'player_id', 'game_date', 1) }} as matchup_fg3a_lag_1g,
        {{ calculate_rolling_avg('matchup_fg3_pct', 'player_id', 'game_date') }} as matchup_fg3_pct_roll_{{ rolling_window_games }}g_avg,
        {{ calculate_rolling_stddev('matchup_fg3_pct', 'player_id', 'game_date') }} as matchup_fg3_pct_roll_{{ rolling_window_games }}g_stddev,
        {{ calculate_lag('matchup_fg3_pct', 'player_id', 'game_date', 1) }} as matchup_fg3_pct_lag_1g,

        -- Timestamps for Incremental
        boxscores.updated_at

    from boxscores
)

select *
from final 